<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<script src="d3.v3.js"></script>
<style>
h2{
	text-align:center;
}

.axes line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}

.male {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.female {
  fill: none;
  stroke: #E75480;
  stroke-width: 1.5px;
}




</style>
<script type="text/javascript">

var nested_data,xscale,yscale;
var Agegroups=[];
var pclass_list=[];
function map_age_to_group(x){
    if(x<10)
    {    return '0-9';}
    else if(x<20)
    {    return '10-19';}
    else if(x<30)
    {    return '20-29';}
    else if(x<40)
    {    return '30-39';}
    else if(x<50)
    {    return '40-49';}
    else if(x<60)
    {    return '50-59';}
    else if(x<70)
    {    return '60-69';}
    else if(x<80)
    {    return '70-79';}
    else
	{
        return '80+'
	}
}
//function to sort nested data
function sort_data(a,b){
	if(a.key>b.key)
		return 1;
	else	
		return 0;
}


function draw_line(pclass)
{
		
		var female_line = d3.svg.line()
		.x(function(d) { return xscale(d['key']); })
		.y(function(d) { 
		if(typeof d['values'][0]!='undefined'){
			if(d['values'][0]['key']=='female'){
				//debugger;
				for(i=0;i<d.values[0].values.length;i++)
				{
					if(d.values[0].values[i].key==pclass)
					{
						return yscale(d['values'][0]['values'][i]['values']['survivor_count']);
					}
				
				} 
				
			return yscale(0);	
			}
			else
			{
				return yscale(0);
			}
			
		}
		});
		
		
		var male_line = d3.svg.line()
		.x(function(d) { return xscale(d['key']); })
		.y(function(d) { 
		

		
		if(typeof d['values'][1] !='undefined'){
			if (d['values'][1]['key']=='male')
			{
				for(i=0;i<d.values[1].values.length;i++)
				{
					if(d.values[1].values[i].key==pclass)
					{
						return yscale(d['values'][1]['values'][i]['values']['survial_percentage']);
					}
				
				} 
				return yscale(0); 
				
			}
		}
		else if(typeof d['values'][0]!='undefined'){
			if(d['values'][0].key=='male')
			{
				for(i=0;i<d.values[0].values.length;i++)
				{
					if(d.values[0].values[i].key==pclass)
					{
						return yscale(d['values'][0]['values'][i]['values']['survial_percentage']);
					}
				
				} 
				return yscale(0);
					
			}
		}
		else
		{
				return yscale(0);
		}
		
		});
	
		
		
	
		/*
		d3.select('svg')
		  .selectAll('circle')
		  .data(nested_data)
		  .enter()
		  .append('circle')
		  .attr('cx',function(d){
				return xscale(d['key']);
		  })
		  .attr('cy',function(d){
				return yscale(d3.sum(d['values'][0]['values'],function(g){return g['values']['survivor_count']}));
		  
		  })
		  .attr('r',2);
		  */
		
		d3.select('svg').selectAll('.line').remove();
		
		d3.select('svg')
		  .append('path')
		  .attr('class','male line')
		  .attr('d',male_line(nested_data))

		
		d3.select('svg')
		  .append('path')
		  .attr('class','female line')
		  .attr('d',female_line(nested_data));
		  
		//d3.select('svg').selectAll()
		  
}

function draw(data){
//Calculating male and female mean age to populate missing values
var male_avg,female_avg;
	male_avg=d3.mean(data.filter(function(d){
		return d['Sex']==='male'& d['Age']!=0;
	}),function(d){return d['Age']});
	female_avg=d3.mean(data.filter(function(d){
		return d['Sex']==='female' & d['Age']!=0;
	}),function(d){return d['Age']});
	
//Setting the average male and female age as calculated in the previous step	
data.forEach(function(d)
{
	if (d['Sex']==='male' & d['Age']===0){
			d['Age']=male_avg;
		}
	if (d['Sex']==='female' & d['Age']===0){
			d['Age']=female_avg;
		}
	d['Age_group']=map_age_to_group(d['Age']);		
	return d;	
}	
)		

//Aggregating the data
nested_data= d3.nest()
					.key(function(d){return d.Age_group;})
					.key(function(d){return d.Sex;}).sortKeys(d3.ascending)
					.key(function(d){return d.Pclass;})
					.rollup(function(leaves){
						
						var survivor_count=leaves.filter(function(d){return d['Survived']==1}).length;
						var dead_count=leaves.filter(function(d){return d['Survived']==0}).length;
						var survial_percentage=(survivor_count*100)/(survivor_count+dead_count)
						return{
							survivor_count,
							dead_count,
							survial_percentage
						}
					
					})
					.entries(data)
					.sort(sort_data);

					
	var margin = 75,
        width = 1300 - margin,
        height = 600 - margin;
		nested_data.forEach(
			function(d){
				Agegroups.push(d.key);
			}
		)
		nested_data[0].values[0].values.forEach(
			function(d){
				pclass_list.push(d.key);
			}
		
		);

		xscale=d3.scale.ordinal()
							.domain(Agegroups)
							.rangePoints([margin,width]);
	    yscale=d3.scale.linear()
								  .domain([0,100])
								  .range([height,margin]);
		var xaxis=d3.svg.axis()
						.scale(xscale)
						.orient('bottom');
		var yaxis=d3.svg.axis()
				 .scale(yscale)
				 .orient("left");
		//Title for the chart
		d3.select('body').append('h2').text('Titanic Survival Analysis');
		
		//drawing buttons
	var buttons=d3.select('body')
					  .append('div')
					  .attr('class','pclass_buttons').attr('style','height:18px;width:1150px;text-align:right;background:white').text('Pclass')
					  .selectAll('div')					  
					  .data(pclass_list)
					  .enter()
					  .append('div')
					  .attr('class','Pclass')
					  .text(function(d){
							return d;
					  })
					  .attr('style',function(d,i){
							return 'float:left;position:relative;left:'+(width-(3-i)*20)+'px;text-align:center;background:#00CED1;border-color:black;border-width:2px;width:40px;height:18px';
					  });
					  buttons.on('click',function(d)
					  {
							d3.selectAll('.Pclass')
							  .transition()
							  .duration(500)
							  .style('background','#00CED1')
							  .style('color','black');
							d3.select(this)
							  .transition()
							  .duration(500)
							  .style('background','lightBlue')
							  .style('color','white');
							draw_line(d);
					  }
					  )
					  
		var svg = d3.select("body")
					.append("svg")
					.attr("width", width + margin)
					.attr("height", height + margin)
		svg.append('h1').text('Survival Analysis: Titanic');
		
					d3.select('svg').append('g')
					.attr('class', 'chart');
		d3.select('g')
			   .append('g').attr('class','x axis')
			   .attr('transform','translate(0,'+height+')')
			   .call(xaxis);
		
		d3.select('g')
				.append('g').attr('class','y axis')
							.attr('transform','translate('+margin+',0)')
							.call(yaxis);
	
		


		
draw_line('1');

		  //legends
		  var radius=3;
		   var legend=d3.select('svg').append('g').attr('class','legend').attr('transform','translate('+(width/2-50)+','+(height+50)+')')
		  .selectAll('g')
		  .data(['Male','Female'])
		  .enter()
		  .append('g');
		  legend.append('circle')
				.attr('cx',function(d,i){
					return i*70;
				})
				.attr('fill',function(d){
					if (d=='Male'){
						return 'steelblue';
					}
					else{
						return '#E75480';
					}
				})
				.attr('r',radius);
			legend.append("text")
				.attr('y',function(d,i){
					return 5;
				})
				.attr('x',function(d,i){return i*70+5;})
				.text(function(d){
					return d;
				});
			


					   

}
</script>
</head>

<body>
<script type="text/javascript">
d3.csv("titanic_data.csv",function(d){
	d['Age']=+d['Age'];
	return d;
},
draw);
</script>
</body>
</html>